generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── M00: Authentication ────────────────────────────────

enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
}

model User {
  user_id         String     @id @default(uuid()) @db.Uuid
  username        String     @unique @db.VarChar(50)
  email           String     @unique @db.VarChar(255)
  password_hash   String     @db.VarChar(255)
  display_name    String     @db.VarChar(100)
  status          UserStatus @default(ACTIVE)
  last_login_at   DateTime?
  failed_attempts Int        @default(0)
  locked_until    DateTime?
  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt

  user_companies     UserCompany[]
  user_company_roles UserCompanyRole[]

  @@map("users")
}

// ─── M01: Roles & Permissions ───────────────────────────

model Role {
  role_id     Int     @id @default(autoincrement())
  role_name   String  @unique @db.VarChar(50)
  description String? @db.VarChar(255)
  is_system   Boolean @default(false)
  created_at  DateTime @default(now())

  role_permissions   RolePermission[]
  user_company_roles UserCompanyRole[]

  @@map("roles")
}

model Permission {
  permission_id   Int    @id @default(autoincrement())
  permission_code String @unique @db.VarChar(50)
  permission_name String @db.VarChar(100)
  module          String @db.VarChar(50)
  created_at      DateTime @default(now())

  role_permissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id            Int @id @default(autoincrement())
  role_id       Int
  permission_id Int

  role       Role       @relation(fields: [role_id], references: [role_id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [permission_id], onDelete: Cascade)

  @@unique([role_id, permission_id])
  @@map("role_permissions")
}

model UserCompanyRole {
  id         Int    @id @default(autoincrement())
  user_id    String @db.Uuid
  role_id    Int
  company_id String @db.Uuid

  user    User    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  role    Role    @relation(fields: [role_id], references: [role_id], onDelete: Cascade)
  company Company @relation(fields: [company_id], references: [company_id], onDelete: Cascade)

  @@unique([user_id, role_id, company_id])
  @@index([user_id, company_id])
  @@map("user_company_roles")
}

// ─── M02: Companies ─────────────────────────────────────

enum CompanyStatus {
  ACTIVE
  INACTIVE
}

model Company {
  company_id        String        @id @default(uuid()) @db.Uuid
  company_name      String        @db.VarChar(200)
  short_name        String?       @db.VarChar(50)
  tax_id            String?       @db.VarChar(8)
  representative    String?       @db.VarChar(50)
  phone             String?       @db.VarChar(20)
  fax               String?       @db.VarChar(20)
  address           String?
  email             String?       @db.VarChar(100)
  default_currency  String        @default("TWD") @db.VarChar(3)
  tax_rate          Decimal       @default(5.00) @db.Decimal(5, 2)
  fiscal_year_start Int           @default(1)
  logo_url          String?       @db.VarChar(500)
  status            CompanyStatus @default(ACTIVE)
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  user_companies     UserCompany[]
  user_company_roles UserCompanyRole[]
  customers          Customer[]
  ar_invoices        ArInvoice[]
  vendors            Vendor[]
  ap_bills           ApBill[]

  @@map("companies")
}

model UserCompany {
  id         Int      @id @default(autoincrement())
  user_id    String   @db.Uuid
  company_id String   @db.Uuid
  is_default Boolean  @default(false)
  joined_at  DateTime @default(now())

  user    User    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  company Company @relation(fields: [company_id], references: [company_id], onDelete: Cascade)

  @@unique([user_id, company_id])
  @@map("user_companies")
}

// ─── M03: Customer Management ────────────────────────────

model Customer {
  customer_id    String   @id @default(uuid()) @db.Uuid
  customer_code  String   @db.VarChar(20)
  customer_name  String   @db.VarChar(200)
  short_name     String?  @db.VarChar(50)
  tax_id         String?  @db.VarChar(8)
  contact_person String?  @db.VarChar(100)
  phone          String?  @db.VarChar(30)
  fax            String?  @db.VarChar(30)
  email          String?  @db.VarChar(255)
  address        String?
  payment_terms  Int      @default(30)
  credit_limit   Decimal  @default(0) @db.Decimal(15, 2)
  notes          String?
  status         String   @default("ACTIVE") @db.VarChar(10)
  company_id     String   @db.Uuid
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  company  Company     @relation(fields: [company_id], references: [company_id], onDelete: Cascade)
  invoices ArInvoice[]

  @@unique([company_id, customer_code])
  @@index([company_id])
  @@map("customers")
}

// ─── M04: Accounts Receivable ────────────────────────────

enum InvoiceStatus {
  DRAFT
  ISSUED
  PARTIALLY_PAID
  PAID
  OVERDUE
  VOID
}

model ArInvoice {
  invoice_id     String        @id @default(uuid()) @db.Uuid
  invoice_number String        @db.VarChar(30)
  customer_id    String        @db.Uuid
  invoice_date   DateTime      @db.Date
  due_date       DateTime      @db.Date
  subtotal       Decimal       @db.Decimal(15, 2)
  tax_amount     Decimal       @db.Decimal(15, 2)
  total_amount   Decimal       @db.Decimal(15, 2)
  paid_amount    Decimal       @default(0) @db.Decimal(15, 2)
  currency       String        @default("TWD") @db.VarChar(3)
  status         InvoiceStatus @default(DRAFT)
  description    String?
  notes          String?
  company_id     String        @db.Uuid
  created_by     String        @db.Uuid
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt

  customer Customer  @relation(fields: [customer_id], references: [customer_id], onDelete: Cascade)
  company  Company   @relation(fields: [company_id], references: [company_id], onDelete: Cascade)
  payments ArPayment[]

  @@unique([company_id, invoice_number])
  @@index([company_id, status])
  @@index([customer_id])
  @@index([due_date])
  @@map("ar_invoices")
}

enum PaymentMethod {
  BANK_TRANSFER
  CHECK
  CASH
  CREDIT_CARD
  OTHER
}

model ArPayment {
  payment_id     String        @id @default(uuid()) @db.Uuid
  invoice_id     String        @db.Uuid
  payment_date   DateTime      @db.Date
  amount         Decimal       @db.Decimal(15, 2)
  payment_method PaymentMethod @default(BANK_TRANSFER)
  reference_no   String?       @db.VarChar(50)
  notes          String?
  company_id     String        @db.Uuid
  created_by     String        @db.Uuid
  created_at     DateTime      @default(now())

  invoice ArInvoice @relation(fields: [invoice_id], references: [invoice_id], onDelete: Cascade)

  @@index([invoice_id])
  @@map("ar_payments")
}

// ─── M05: Vendor Management ────────────────────────────

model Vendor {
  vendor_id      String   @id @default(uuid()) @db.Uuid
  vendor_code    String   @db.VarChar(20)
  vendor_name    String   @db.VarChar(200)
  short_name     String?  @db.VarChar(50)
  tax_id         String?  @db.VarChar(8)
  contact_person String?  @db.VarChar(100)
  phone          String?  @db.VarChar(30)
  fax            String?  @db.VarChar(30)
  email          String?  @db.VarChar(255)
  address        String?
  payment_terms  Int      @default(30)
  credit_limit   Decimal  @default(0) @db.Decimal(15, 2)
  notes          String?
  status         String   @default("ACTIVE") @db.VarChar(10)
  company_id     String   @db.Uuid
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  company Company  @relation(fields: [company_id], references: [company_id], onDelete: Cascade)
  bills   ApBill[]

  @@unique([company_id, vendor_code])
  @@index([company_id])
  @@map("vendors")
}

// ─── M06: Accounts Payable ─────────────────────────────

model ApBill {
  bill_id      String        @id @default(uuid()) @db.Uuid
  bill_number  String        @db.VarChar(30)
  vendor_id    String        @db.Uuid
  bill_date    DateTime      @db.Date
  due_date     DateTime      @db.Date
  subtotal     Decimal       @db.Decimal(15, 2)
  tax_amount   Decimal       @db.Decimal(15, 2)
  total_amount Decimal       @db.Decimal(15, 2)
  paid_amount  Decimal       @default(0) @db.Decimal(15, 2)
  currency     String        @default("TWD") @db.VarChar(3)
  status       InvoiceStatus @default(DRAFT)
  description  String?
  notes        String?
  company_id   String        @db.Uuid
  created_by   String        @db.Uuid
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt

  vendor   Vendor      @relation(fields: [vendor_id], references: [vendor_id], onDelete: Cascade)
  company  Company     @relation(fields: [company_id], references: [company_id], onDelete: Cascade)
  payments ApPayment[]

  @@unique([company_id, bill_number])
  @@index([company_id, status])
  @@index([vendor_id])
  @@index([due_date])
  @@map("ap_bills")
}

model ApPayment {
  payment_id     String        @id @default(uuid()) @db.Uuid
  bill_id        String        @db.Uuid
  payment_date   DateTime      @db.Date
  amount         Decimal       @db.Decimal(15, 2)
  payment_method PaymentMethod @default(BANK_TRANSFER)
  reference_no   String?       @db.VarChar(50)
  notes          String?
  company_id     String        @db.Uuid
  created_by     String        @db.Uuid
  created_at     DateTime      @default(now())

  bill ApBill @relation(fields: [bill_id], references: [bill_id], onDelete: Cascade)

  @@index([bill_id])
  @@map("ap_payments")
}
